---
date: 2026-02-22
project: stock-prediction-sagemaker
status: planning
tags: [ml, lightgbm, stock-prediction, qqq, vegas-channel, hull, macd, rsi]
---

# ğŸ“ˆ QQQ è‚¡ç¥¨é¢„æµ‹é¡¹ç›®å®Œæ•´å®æ–½æ–¹æ¡ˆ

> åŸºäº Vegas Channel + Hull å’Œ MACD+RSI ç­–ç•¥ï¼Œè®­ç»ƒ LightGBM æ¨¡å‹é¢„æµ‹æœªæ¥15æ—¥æ”¶ç›Šç‡

---

## ğŸ¯ é¡¹ç›®ç›®æ ‡

- **æ ‡çš„**: QQQ (Invesco QQQ Trust)
- **æ•°æ®èŒƒå›´**: 2020-01-01 è‡³ 2025-02-22ï¼ˆçº¦5å¹´ï¼‰
- **é¢„æµ‹ç›®æ ‡**: æœªæ¥15æ—¥æ”¶ç›Šç‡ï¼ˆ%ï¼‰ + é£é™©è¯„åˆ†ï¼ˆä¸‹è¡Œæ³¢åŠ¨ï¼‰
- **æ¨¡å‹**: LightGBM å›å½’ï¼ˆå¤šè¾“å‡ºæˆ–å•ç‹¬æ¨¡å‹ï¼‰
- **éƒ¨ç½²**: æœ¬åœ° ONNX + FastAPIï¼Œåç»­å¯é€‰ SageMaker
- **è¯„ä¼°**: æŒ‰é¢„æµ‹åˆ†æ•°åˆ†ç»„çš„å®é™…æ”¶ç›Šåˆ†å¸ƒï¼ˆåº”å•è°ƒé€’å¢ï¼‰

---

## ğŸ“Š æ•°æ®ç­–ç•¥

### æ•°æ®æº
- `yfinance` ä¸‹è½½ QQQ æ—¥çº¿æ•°æ®ï¼ˆOHLC + Volumeï¼‰
- åŒæ—¶ä¸‹è½½ SPY ä½œä¸ºå¸‚åœºåŸºå‡†

### ç‰¹å¾å·¥ç¨‹ï¼ˆæ ¸å¿ƒï¼‰

#### 1. Vegas Channel ç‰¹å¾
```python
# å‚æ•°: MA1=144, MA2=169, MA12=576, MA22=676 (default)
MA1 = ta.ema(close, 144)
MA2 = ta.ema(close, 169)
MA12 = ta.ema(close, 576)
MA22 = ta.ema(close, 676)

veg_fast_band_width = (MA1 - MA2) / MA2
veg_slow_band_width = (MA12 - MA22) / MA22
veg_price_position = (close - MA1) / (MA22 - MA1)  # normalize 0-1
veg_filter_slope = (ta.ema(close, 12) - ta.ema(close, 12)[1]) / ta.ema(close, 12)[1]

# ç­–ç•¥ä¿¡å·ï¼ˆ0=neutral, 1=long, -1=shortï¼‰
veg_signal = 1 if (MA1 > MA12 and close > MA1 and maSlop > 0) else (-1 if (MA1 < MA12 and close < MA1 and maSlop < 0) else 0)
```

#### 2. Hull Moving Average ç‰¹å¾
```python
def HMA(src, length):
    return ta.wma(2 * ta.wma(src, length // 2) - ta.wma(src, length), int(math.sqrt(length)))

HULL = HMA(close, 55)
hull_direction = 1 if HULL > HULL[1] else 0  # 1=up, 0=down
hull_slope = (HULL - HULL[1]) / HULL[1]
hull_signal = 1 if (HULL > HULL[1] and low > HULL[0] and low > HULL[2]) else (-1 if (HULL <= HULL[1] and high < HULL[0] and high < HULL[2]) else 0)
```

#### 3. MACD + RSI + Stochastic
```python
# MACD (12, 26, 9)
macd_line = ta.ema(close, 12) - ta.ema(close, 26)
signal_line = ta.ema(macd_line, 9)
macd_hist = macd_line - signal_line
macd_bullish = 1 if macd_line > 0 and signal_line > 0 else 0
macd_crossover = 1 if macd_line > signal_line else 0

# RSI (14)
rsi = ta.rsi(close, 14)
rsi_overbought = 1 if rsi > 70 else (0 if 40 < rsi <= 70 else -1)

# Stochastic (14, 3, 3)
stoch_k = ta.stoch(close, close, close, 14)
stoch_d = ta.sma(stoch_k, 3)
stoch_bullish = 1 if stoch_k > stoch_d else 0
```

#### 4. æˆäº¤é‡ä¸æ³¢åŠ¨ç‡
```python
volume_ratio = volume / ta.sma(volume, 20)
atr_pct = ta.atr(14) / close
bb_upper = ta.bbands(close, 20, 2).upper
bb_lower = ta.bbands(close, 20, 2).lower
bb_width = (bb_upper - bb_lower) / close
```

#### 5. å¸‚åœºåŸºå‡†
```python
# éœ€è¦åŒæ—¶ä¸‹è½½ SPY
spy_close = spy_data['Close']
spy_return_5d = spy_close / spy_close.shift(5) - 1
spy_return_15d = spy_close / spy_close.shift(15) - 1
relative_strength = close / spy_close  # QQQ/SPY æ¯”å€¼
```

#### 6. æ—¶é—´ç‰¹å¾
```python
day_of_week = df.index.dayofweek  # 0=Monday
month = df.index.month
quarter = df.index.quarter
```

---

### æ ‡ç­¾å®šä¹‰ï¼ˆTargetï¼‰

**ä¸»æ ‡ç­¾**:
- `target_15d` = `(close.shift(-15) / close - 1) * 100`  # æœªæ¥15æ—¥æ”¶ç›Šç‡ï¼ˆ%ï¼‰
- `target_risk` = è®¡ç®—æœªæ¥15æ—¥æœ€å¤§å›æ’¤ï¼ˆ%ï¼‰ï¼š`max_drawdown = max(close[i] / close[0] - 1 for i in 0..15)`

**å¯é€‰è¡ç”Ÿæ ‡ç­¾**:
- `target_success` = 1 if `target_15d > threshold` else 0  # é˜ˆå€¼å¯è®¾ä¸º 2%ï¼ˆå¹´åŒ–â‰ˆ50%ï¼‰
- `target_risk_adjusted` = `target_15d / (abs(target_risk) + 1e-6)`  # é£é™©è°ƒæ•´æ”¶ç›Š

---

## ğŸ—‚ï¸ é¡¹ç›®ç»“æ„

```
StockPredictor/
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ raw/           # åŸå§‹æ•°æ®ï¼ˆyfinance ä¸‹è½½ï¼‰
â”‚   â”œâ”€â”€ processed/     # ç‰¹å¾å·¥ç¨‹åçš„æ•°æ®é›†
â”‚   â””â”€â”€ splits/        # è®­ç»ƒ/éªŒè¯/æµ‹è¯•é›†
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ data_preparation.py   # ä¸‹è½½æ•°æ® + ç‰¹å¾å·¥ç¨‹
â”‚   â”œâ”€â”€ train.py              # æ¨¡å‹è®­ç»ƒ
â”‚   â”œâ”€â”€ evaluate.py           # æ¨¡å‹è¯„ä¼°
â”‚   â”œâ”€â”€ inference.py          # æœ¬åœ°æ¨ç† API
â”‚   â””â”€â”€ config.py             # å‚æ•°é…ç½®
â”œâ”€â”€ models/
â”‚   â”œâ”€â”€ checkpoints/          # è®­ç»ƒå¥½çš„æ¨¡å‹ï¼ˆjoblibï¼‰
â”‚   â””â”€â”€ onnx/                 # ONNX å¯¼å‡º
â”œâ”€â”€ notebooks/
â”‚   â””â”€â”€ 01_eda.ipynb         # æ¢ç´¢æ€§åˆ†æ
â”œâ”€â”€ tests/
â”œâ”€â”€ requirements.txt
â”œâ”€â”€ README.md
â””â”€â”€ train_deploy_sagemaker.py # è¿ç§»åˆ° SageMaker çš„è„šæœ¬
```

---

## ğŸ“ˆ è®­ç»ƒæµç¨‹

### æ•°æ®åˆ†å‰²ï¼ˆæ—¶é—´åºåˆ—ï¼ï¼‰
- è®­ç»ƒé›†: 2020-01-01 ~ 2024-12-31 (5å¹´)
- éªŒè¯é›†: 2025-01-01 ~ 2025-12-31 (1å¹´)
- æµ‹è¯•é›†: 2026-01-01 ~ 2026-02-23 (æœ€æ–°2ä¸ªæœˆ)

### æ¨¡å‹æ¶æ„
```python
import lightgbm as lgb

params = {
    'objective': 'regression',
    'metric': 'rmse',
    'boosting_type': 'gbdt',
    'num_leaves': 31,
    'learning_rate': 0.05,
    'feature_fraction': 0.8,
    'bagging_fraction': 0.8,
    'bagging_freq': 5,
    'verbose': 0,
    'random_state': 42,
}

train_data = lgb.Dataset(X_train, label=y_train)
val_data = lgb.Dataset(X_val, label=y_val, reference=train_data)

model = lgb.train(
    params,
    train_data,
    valid_sets=[train_data, val_data],
    num_boost_round=1000,
    callbacks=[lgb.early_stopping(50)]
)
```

### è¯„ä¼°æŒ‡æ ‡
1. **æ•´ä½“**: RÂ², RMSE, MAE
2. **åˆ†ç»„åˆ†æ**:
   - å°†æµ‹è¯•é›†æŒ‰é¢„æµ‹å€¼åˆ†ä¸º 5 ç»„ï¼ˆQ1~Q5ï¼‰
   - è®¡ç®—æ¯ç»„çš„å®é™…å¹³å‡ `target_15d`
   - é¢„æœŸï¼šQ5 > Q4 > Q3 > Q2 > Q1ï¼ˆå•è°ƒé€’å¢ï¼‰
3. **ç­–ç•¥æ¨¡æ‹Ÿ**:
   - åªäº¤æ˜“é¢„æµ‹å€¼æœ€é«˜çš„ Top 20% æ ·æœ¬
   - è®¡ç®—ï¼šèƒœç‡ã€ç›ˆäºæ¯”ã€å¤æ™®æ¯”ç‡ã€æœ€å¤§å›æ’¤

---

## ğŸš€ éƒ¨ç½²æ–¹æ¡ˆ

### Phase 1: æœ¬åœ°æ¨ç†ï¼ˆFastAPIï¼‰
```python
# inference.py
from fastapi import FastAPI
import onnxruntime as ort
import pandas as pd
import numpy as np

app = FastAPI()
session = ort.InferenceSession("models/onnx/model.onnx")

@app.post("/predict")
def predict(date: str, open: float, high: float, low: float, close: float, volume: int):
    # 1. æ¥æ”¶å®æ—¶æ•°æ®
    # 2. è®¡ç®—æ‰€æœ‰ç‰¹å¾ï¼ˆä¸è®­ç»ƒæ—¶ä¸€è‡´ï¼‰
    # 3. è°ƒç”¨ ONNX æ¨¡å‹
    # 4. è¿”å›: {'expected_15d_return': 2.5, 'risk_score': 1.2, 'signal_strength': 0.8}
```

### Phase 2: SageMaker è®­ç»ƒï¼ˆå¯é€‰ï¼‰
- ä½¿ç”¨ `train_deploy_sagemaker.py` è„šæœ¬
- SKLearn Estimatorï¼ˆåŒ…è£… LightGBMï¼‰
- è‡ªåŠ¨æ¨¡å‹æ³¨å†Œå’Œéƒ¨ç½²

---

## ğŸ’° æˆæœ¬ä¼°ç®—

| é¡¹ç›® | æˆæœ¬ |
|------|------|
| æ•°æ®ä¸‹è½½ | å…è´¹ï¼ˆyfinanceï¼‰ |
| è®­ç»ƒ (SageMaker ml.m5.xlarge, 2h) | ~$0.4 |
| S3 å­˜å‚¨ (100MB) | <$0.01/æœˆ |
| æœ¬åœ°æ¨ç† | 0ï¼ˆä»… CPUï¼‰ |
| **æ€»è®¡** | **< $1**ï¼ˆå®éªŒé˜¶æ®µï¼‰ |

---

## âš ï¸ é£é™©ä¸æ³¨æ„äº‹é¡¹

1. **è¿‡æ‹Ÿåˆ**: å¿…é¡»æ—¶é—´åºåˆ—åˆ†å‰²ï¼Œä¸¥ç¦éšæœº
2. **æœªæ¥ä¿¡æ¯æ³„éœ²**: ç‰¹å¾è®¡ç®—åªç”¨å½“æ—¶å·²çŸ¥æ•°æ®ï¼ˆä¸¥æ ¼ shiftï¼‰
3. **äº¤æ˜“æˆæœ¬æœªè€ƒè™‘**: é¢„æµ‹æ”¶ç›Šéœ€ > ä½£é‡‘+æ»‘ç‚¹æ‰æœ‰æ„ä¹‰
4. **æ¨¡å‹æœ‰æ•ˆæœŸ**: å¸‚åœºå˜åŒ–ï¼Œæ¨¡å‹éœ€å®šæœŸé‡è®­ï¼ˆå»ºè®®æ¯æœˆï¼‰

---

## ğŸ”— ç›¸å…³èµ„æº

- [[Bedrock é›†æˆæŒ‡å—]]ï¼ˆå¯ç”¨äºç”Ÿæˆè‡ªç„¶è¯­è¨€åˆ†ææŠ¥å‘Šï¼‰
- [[SageMaker å®Œæ•´å­¦ä¹ ä¸åº”ç”¨æŒ‡å—]]
- [[SelfProject/StockPredictor/ç­–ç•¥åˆ†æä¸MLåº”ç”¨å»ºè®®]]
- [[SelfProject/StockPredictor/Pine Script - Vegas Channel + Hull STRG]]
- [[SelfProject/StockPredictor/Pine Script -MACD-RSI]]

---

## ğŸ¯ ä¸‹ä¸€æ­¥

1. è¿è¡Œ `data_preparation.py` ç”Ÿæˆç‰¹å¾æ•°æ®é›†
2. æœ¬åœ°è®­ç»ƒåŸºçº¿ LightGBM æ¨¡å‹
3. è¯„ä¼°åˆ†ç»„æ”¶ç›Šå•è°ƒæ€§
4. å¦‚æœæœ‰æ•ˆï¼Œå¯¼å‡º ONNX å¹¶ç”¨ FastAPI æµ‹è¯•
5. è¿ç§»åˆ° SageMaker å®ç°è‡ªåŠ¨åŒ–

---

*æœ€åæ›´æ–°: 2026-02-22 23:20 EST*