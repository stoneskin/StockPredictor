---
date: 2026-02-22
project: stock-prediction-sagemaker
status: analysis
tags: [pine-script, strategy-analysis, vegas-channel, hull, macd, rsi, machine-learning]
---

# 📊 Pine Script 策略分析与机器学习应用建议

> 基于 Vegas Channel + Hull STRG 和 MACD+RSI 两个策略，设计机器学习增强方案

---

## 🎯 策略概览

### 策略 1: Vegas Channel + Hull STRG（趋势跟踪）

**核心逻辑：**
- **Vegas Channel**: 双层 EMA 通道（快：144/169，慢：576/676）
  - 价格在快通道内且快通道在慢通道之上 → 多头
  - 过滤线（12 EMA）斜率确认趋势强度
- **Hull MA (55-period)**:
  - HULL > HULL[2] → 上升趋势
  - HULL < HULL[2] → 下降趋势
- **入场条件**：
  - **Long**: MA1>MA12 AND close>MA1 AND Hull上升
  - **Short**: MA1<MA12 AND close<MA1 AND Hull下降
- **出场条件**：
  - 价格跌破 MA1/MA2/MA12/MA22 或 Hull趋势反转

**特点：** 趋势跟踪，顺势而为，多层确认减少假信号

---

### 策略 2: MACD+RSI 自学习预测（模式识别）

**核心逻辑：**
1. **信号编码**：将技术指标状态组合成字符串键
   ```
   P_ + bullTrand (1/0) + macdStatus (1/0) + rsiStatus (1/0) + rsiOverStatus (1/0) + "true"
   ```
   - 示例：`P_1010true` 表示：MACD看涨、MACD线在信号线上方、RSI上升、RSI未超买

2. **历史统计**：
   - 在训练期（如 2020-2021），对每个信号键统计：
     - 出现次数、胜率、盈亏比、最大盈利/亏损
   - 关键指标：`upRate = (winCt - lossCt) / (winCt + lossCt) * 100`

3. **交易决策**：
   - **Long**: 信号键的 `upRate > 10%`（历史胜率超过50%且优势明显）
   - **Short**: `upRate < -10%`
   - 使用 3% 止损

**特点：** 数据驱动，自适应市场，但统计可靠性依赖样本量

---

## 🤖 机器学习能做什么？（结合两者优势）

### ✅ 任务 1: **预测信号质量**（回归）

> 问题：当前这个信号（Vegas+Hull 或 MACD+RSI 组合）未来的表现会如何？

**方案：**
- **输入**: 当前所有技术指标值（连续+状态）
- **输出**: 未来 N 根 K 线的最大涨幅/收益率（回归值）
- **模型**: LightGBM Regression
- **用途**: 只交易预测收益率 > 阈值的信号，过滤低质量交易

**特征设计示例：**
```python
features = {
    'veg_fast_ratio': MA1 / MA2,              # 快通道宽度
    'veg_slow_ratio': MA12 / MA22,            # 慢通道宽度
    'veg_position': (close - MA1) / (MA22-MA1),  # 价格在通道中的位置 (0-1)
    'veg_filter_slope': maSlop,                # 过滤线斜率
    'hull_direction': HULL > HULL[2] ? 1 : 0,
    'hull_value': HULL,
    'macd_hist': macd - signal,                # MACD 柱状图
    'rsi_value': rsi,
    'stoch_k': k, 'stoch_d': d,
    'volume_ratio': volume / volume_MA20,      # 成交量相对强度
    'volatility': ATR(14) / close,             # 波动率
    'day_of_week': weekday,                    # 星期效应
}
```

---

### ✅ 任务 2: **增强信号生成**（分类）

> 问题：给定当前技术指标状态，未来 N 根 K 线涨跌的概率是多少？

**方案：**
- **输入**: 同上，但包括更多状态组合
- **输出**: 二分类（上涨 vs 下跌）或三分类（上涨/震荡/下跌）
- **模型**: LightGBM Classifier
- **用途**: 作为独立预测器，或与现有策略信号融合（加权投票）

**优势**: 比简单的历史统计更平滑，能处理连续特征，可解释性强（特征重要性）

---

### ✅ 任务 3: **动态参数优化**（多输出）

> 问题：当前市场条件下，Vegas Channel 的最优参数是什么？（例如：144/169 是否合适？）

**方案：**
- **输入**: 市场状态特征（波动率、趋势强度、成交量、ADX等）
- **输出**: 建议的参数偏移量（如 multiplierFast = 1.2, multiplierSlow = 0.8）
- **模型**: 多输出回归或分类
- **用途**: 自适应调整策略参数，避免固定参数在不同市场失效

**注意**: 这需要大量历史数据回测不同参数组合，生成训练样本

---

### ✅ 任务 4: **风险预测**（回归）

> 问题：这次交易的潜在最大回撤/最大盈利是多少？

**方案：**
- **输入**: 入场时的技术指标 + 市场环境
- **输出**: 预期最大盈利百分比、预期最大亏损百分比
- **用途**: 动态调整仓位大小（凯利公式变体），或决定是否开仓

---

### ✅ 任务 5: **市场状态分类**（无监督/半监督）

> 问题：当前是趋势市、震荡市还是高波动市？

**方案：**
- **输入**: ADX、布林带宽度、ATR、成交量等
- **输出**: 市场状态标签（可先用 K-Means 聚类，再人工标注）
- **用途**: 在不同市场状态使用不同的策略参数或完全不同的模型

---

## 📋 推荐实施路径（从小到大的迭代）

### **Phase 1: 基线 - 预测次日方向（2周）**

**目标**: 预测下一个交易日收盘价相对于当前是涨还是跌（二分类）

**数据准备**:
- 日线数据 + 所有技术指标（至少 50 个特征）
- 标签: `next_day_return > 0` → 1, else 0

**训练**:
- 本地 LightGBM 快速迭代
- 训练/验证集划分：时间序列切分（避免未来信息泄露）

**评估**:
- 准确率、精确率、召回率、F1
- 特别关注 **Precision@Long**（做多信号的准确率），因为你的策略主要做多

**输出**: ONNX 模型，本地 Python 脚本调用

---

### **Phase 2: 增强 - 预测信号质量（2-3周）**

**目标**: 为每个**策略信号**（Vegas+Hull 或 MACD+RSI）打分，预测其未来收益率

**数据准备**:
- 筛选历史信号点（策略产生的 Buy/Sell 信号）
- 特征：信号产生时的所有技术指标
- 标签：信号发出后 N 根 K 线的最大涨幅（或风险调整后收益）

**训练**:
- LightGBM Regression
- 注意类别不平衡（bad signals 可能多于 good signals）

**评估**:
- R²、RMSE
- 更重要的是：按预测分数分组的实际收益分布（应呈正相关）

**集成**:
- 修改 Pine Script，在生成信号后调用本地模型打分
- 只交易分数 > 阈值的信号

---

### **Phase 3: 全自动化 - SageMaker 训练流水线（1-2周）**

**目标**: 将 Phase 2 的训练流程迁移到 SageMaker，实现定期自动重训

**组件**:
- 数据预处理（S3 存储历史数据）
- 训练脚本（支持超参搜索）
- 模型注册（Model Registry）
- 自动部署（当新模型验证指标优于基线时）

**CI/CD**:
- GitHub Actions：每周日晚上运行（交易系统周一开盘前更新模型）

**成本**:
- SageMaker training: <$1/次（ml.m5.xlarge）
- Endpoint: ml.m5.large $0.12/小时，24/7 ≈ $90/月（或按需启动）

---

## ⚠️ 关键注意事项

### 1. **过拟合风险极高**
- 股票数据信噪比低，历史模式不一定重复
- 必须使用**时间序列交叉验证**，严禁随机 shuffle
- 特征工程要基于经济逻辑，避免挖掘噪音

### 2. **未来信息泄露（最致命）**
- 特征计算必须**严格使用当时已知数据**
- 示例：如果计算 20 日均线，只能使用 `close[1]` 及更早的数据（如果是盘中信号）
- 解决方案：在生成数据集时，将每个样本的特征锁定在当时的时间点

### 3. **标签定义要合理**
- **选项 A**: 次日涨跌（适合短线）
- **选项 B**: 未来 5 日/10 日最大涨幅（避免中途波动干扰）
- **选项 C**: 风险调整收益（(max_up - max_down) / ATR）

### 4. **评估陷阱**
- 准确率 55% 听起来低，但考虑交易成本（佣金+滑点）后可能已无利可图
- 关注 **Precision@TopK**（例如：模型打分最高的 20% 信号中，有多少真正盈利）

---

## 💡 快速启动建议

**第一周目标**：复现 Pine Script 的 MACD+RSI 信号逻辑，生成特征，本地训练一个基线模型

**步骤**:
1. 用 `yfinance` 下载 SPY/QQQ 过去 5 年日线数据
2. 用 `ta` 库计算所有指标（MACD、RSI、Stochastic、Hull、Vegas Channel）
3. 生成标签：`next_5day_return = (close.shift(-5) / close - 1)`
4. 训练 LightGBM 回归，预测未来 5 日收益率
5. 评估：按预测值分组，看每组实际收益是否单调

**成功标志**: 模型能区分高收益组和低收益组（即使整体预测误差大）

---

## 🔗 相关资源

- [[Bedrock 集成指南]]（如果想把预测结果用 NLP 解释，可调用 Bedrock）
- [[SageMaker 完整学习与应用指南]]
- [[SelfProject/Stock Prediction with SageMaker]]（本项目主文档）

---

### 🎯 接下来

你可以：
1. 确定优先做哪个任务（我推荐 Phase 1: 预测次日方向）
2. 提供 Pine Script 中具体的参数范围（例如 Vegas Channel 的 144/169/576/676，Hull 55-period，是否还有其他指标）
3. 确定使用的标的（SPY？TSLA？多股票组合？）
4. 我帮你生成完整的数据准备和训练代码

准备好后随时告诉我！